<openerp>
    <data>
        <record id="thankyou_letter_template" model="email.template">
            <field name="name">Donation - Thank You Letter</field>
            <field name="model_id" ref="partner_communication.model_partner_communication_job"/>
            <field name="email_from">compassion@compassion.ch</field>
            <field name="reply_to">info@compassion.ch</field>
            <field name="use_default_to" eval="True"/>
            <field name="subject">Donation Receipt</field>
            <field name="body_html" type="html">
                <style>
                    .success {

                    }
                </style>
                <div>
                    % set invoice_lines = object.get_objects()
                    % set donations = invoice_lines.get_donations()
                    % set partner = object.partner_id
                    % set ambassadors = invoice_lines.mapped('user_id').filtered('ambassador_quote')
                </div>
                <div>
                    ${partner.salutation},
                    <br/>
                    <br/>
                    % if partner.is_new_donator:
                        <p>
                            Welcome in the Compassion Donors family! We are glad to send you some information about our organization.
                            Please don't hesitate to contact us if any of your questions about us are left unanswered.
                            It will be an opportunity to know each other better.
                        </p>
                    % endif
                    We would like to thank you very much for the donation you made to Compassion Switzerland.
                    % if len(donations) == 1:
                        <br/>
                        <br/>
                        <b>Your contribution:</b> CHF ${donations.values()[0]}.- for the ${donations.keys()[0]}.
                    % else:
                        <ul>
                            % for fund, amount in donations.iteritems():
                                <li>
                                    CHF ${amount}.- for the ${fund}
                                </li>
                            % endfor
                        </ul>
                    % endif
                    % if object.event_id:
                        % for ambassador in ambassadors:
                            ${ambassador.ambassador_quote |safe}
                        % endfor
                        % if object.event_id.thank_you_text:
                            ${object.event_id.thank_you_text |safe}
                        % endif
                    % endif
                    <p id="compassion-mission">
                        Compassion is a Christian international holistic child development organisation.
                        Through our Child Sponsorship Program, more than 1.8 million children are currently being released from poverty in Jesus’ name.
                        With over six decades of experience, Compassion’s unique approach to solving poverty works: research proves it.
                    </p>
                    Yours sincerely
                </div>
            </field>
        </record>

        <record id="donation_summary_template" model="email.template">
            <field name="name">Donation - Summary</field>
            <field name="model_id" ref="partner_communication.model_partner_communication_job"/>
            <field name="email_from">rmaglo@compassion.ch</field>
            <field name="use_default_to" eval="True"/>
            <field name="subject">Résumé des donations</field>
            <field name="body_html" type="html">
                <div>
                    % set invoices = object.get_objects()
                    % set month = invoices.get_date('date_invoice', '%B %Y')
                    % set partner = object.partner_id
                </div>
                <div>
                    ${partner.salutation},
                    <br/>
                    <br/>
                    Voici un résumé des donations reçues en ${month} :
                    <br/>
                    <br/>
                    <table style="border: 1px solid black; border-collapse: collapse;">
                        <tr>
                            <th style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Partenaire</th>
                            <th style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Date</th>
                            <th style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Attribution</th>
                            <th style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Montant</th>
                            <th style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Remerciement</th>
                        </tr>
                        % for p, p_invoices in invoices.group_by_partner().iteritems():
                            % set donor = p_invoices.mapped('partner_id')
                            % set comm = p_invoices.mapped('communication_id')[0]
                            % set date = p_invoices.get_date('date_invoice')
                            % set attribution = ', '.join(p_invoices.mapped('invoice_line.product_id.name'))
                            % set total = sum(p_invoices.mapped('amount_total'))
                            <tr>
                                <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">${donor.name}</td>
                                <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">${date}</td>
                                <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">${attribution}</td>
                                <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: right;">${total}</td>
                                % if comm and comm.state == 'done':
                                    <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Remercié par ${'papier' if comm.send_mode == 'physical' else 'e-mail'}</td>
                                % elif comm and comm.state != 'cancel':
                                    <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Pas encore remercié</td>
                                % else:
                                    <td style="border: 1px solid black; padding-right: 5px; padding-left: 5px; text-align: center;">Non remercié ${'selon volonté du parrain' if p.thankyou_letter == 'no' else ''}</td>
                                % endif
                            </tr>
                        % endfor
                    </table>
                </div>
            </field>
        </record>
    </data>
</openerp>
